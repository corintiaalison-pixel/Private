name: security-scan
on:
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect suspicious keywords and large binaries
        shell: bash
        run: |
          set -euo pipefail
          KEYWORDS=(
            "stable-diffusion"
            "stable_diffusion"
            "sd-"
            "sd_"
            "dalle"
            "dall-e"
            "openai.image"
            "openai.images"
            "generate_image"
            "generate_image("
            "img2img"
            "diffusion"
            ".ckpt"
            ".safetensors"
            "huggingface"
            "latents"
            "model="
            "text2image"
            "txt2img"
            ".llc"
          )
          git fetch origin ${{ github.head_ref }}:${{ github.head_ref }} || true
          DIFF=$(git --no-pager diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} || true)
          if [ -z "$DIFF" ]; then
            echo "No file changes detected."
            exit 0
          fi
          echo "Changed files:"
          echo "$DIFF"
          FOUND=0
          for f in $DIFF; do
            if [ ! -f "$f" ]; then
              continue
            fi
            SIZE=$(stat -c%s "$f" || stat -f%z "$f")
            if [ "$SIZE" -gt $((2 * 1024 * 1024)) ]; then
              echo "ERROR: $f is larger than 2MB ($SIZE bytes)."
              FOUND=1
            fi
            for kw in "${KEYWORDS[@]}"; do
              if LC_ALL=C grep -i -n -H -I -e "$kw" "$f" >/dev/null 2>&1; then
                echo "ERROR: Suspicious keyword '$kw' found in $f"
                FOUND=1
              fi
            done
          done
          if [ "$FOUND" -ne 0 ]; then
            echo "::error ::security-scan: Suspicious content detected. Block the PR or remove the content."
            exit 1
          fi
          echo "security-scan passed."
